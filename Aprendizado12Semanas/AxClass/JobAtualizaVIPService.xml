<?xml version="1.0" encoding="utf-8"?>
<AxClass xmlns:i="http://www.w3.org/2001/XMLSchema-instance">
	<Name>JobAtualizaVIPService</Name>
	<SourceCode>
		<Declaration><![CDATA[
internal final class JobAtualizaVIPService
{
}
]]></Declaration>
		<Methods>
			<Method>
				<Name>processar</Name>
				<Source><![CDATA[
    public void processar(JobAtualizaVIPContract _contract)
    {
        CustGroupId grupoEscolhido = _contract.parmCustGroupId();
        Amount valorEscolhido = _contract.parmCreditMax();

        int contador = 0;
        CustTable custTable;

        // Vamos avisar o que estamos tentando fazer
        Info(strFmt("Iniciando... Grupo: %1 | Novo Valor Alvo: %2", grupoEscolhido, valorEscolhido));

        ttsbegin;

        while select forupdate custTable
            where custTable.CustGroup == grupoEscolhido
        {
            // 1. Captura valor antigo
            CustCreditMaxMST limiteAntigo = custTable.CreditMax;

            // 2. Aplica novo valor
            custTable.CreditMax = valorEscolhido;

            // DEBUG: Mostra na tela qual cliente está tentando
            Info(strFmt("Tentando Cliente: %1 | Antigo: %2 | Novo: %3", custTable.AccountNum, limiteAntigo, custTable.CreditMax));

            // 3. TENTA VALIDAR
            if(custTable.validateWrite())
            {
                custTable.update(); // Atualização padrão
                this.createLog(custTable.AccountNum, limiteAntigo, custTable.CreditMax);
                contador++;
                Info(strFmt("Cliente %1 atualizado com SUCESSO via Padrão!", custTable.AccountNum));
            }
            else
            {
                // AQUI ESTÁ O TRUQUE: Se falhar a validação, vamos forçar com doUpdate
                // Apenas para o seu teste funcionar e gravar o log
                custTable.doUpdate();
                
                this.createLog(custTable.AccountNum, limiteAntigo, custTable.CreditMax);
                contador++;
                
                Warning(strFmt("Cliente %1 tinha erros de cadastro, mas forçamos a atualização do limite com doUpdate()!", custTable.AccountNum));
            }
        }

        ttscommit;

        Info(strFmt("Processo Finalizado! Total atualizados: %1", contador));
    }

]]></Source>
			</Method>
			<Method>
				<Name>createLog</Name>
				<Source><![CDATA[
    private void createLog(CustAccount _AccountNum, CustCreditMaxMST _OldLimit, CustCreditMaxMST _NewLimit)
    {
        CustVIPLog custVIPLog;

        custVIPLog.AccountNum = _AccountNum;
        custVIPLog.OldLimit = _OldLimit;
        custVIPLog.NewLimit = _NewLimit;

        custVIPLog.insert();
    }

]]></Source>
			</Method>
		</Methods>
	</SourceCode>
</AxClass>